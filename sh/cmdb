#!/bin/bash
set -x 


die() {
    (
        echo $(date):  Error: "$@"
        echo
    ) |
        (
            flock ~/tmp/logs/cmdb.err.lock tee -a ~/tmp/logs/cmdb.err.txt
        )
    exit -1
}

function cmdb_mysql() {
    (
        set +x
	mkdir -p ~/tmp/logs && echo 123 > ~/.ssh/mysql-cmdb.pass
        if mysql -u root --password=$(cat ~/.ssh/mysql-cmdb.pass) indemind -h 192.168.50.191 --default-character-set=utf8 -e "$@" > ~/tmp/cmdb.db.$$ 2>&1; then
            cat ~/tmp/cmdb.db.$$
            rm -f ~/tmp/cmdb.db.$$
        elif grep 'Duplicate entry' ~/tmp/cmdb.db.$$; then
            rm -f ~/tmp/cmdb.db.$$
        else
            die "sql error input cmdb info"
        fi
    )

}
export -f cmdb_mysql
